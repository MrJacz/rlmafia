// Rocket League Mafia Bot - Prisma Schema
// PostgreSQL database schema for persistent ELO ratings and game history

generator client {
	provider = "prisma-client"
  output        = "../src/generated/prisma"
	engineType = "client"
	runtime = "bun"
}

datasource db {
  provider = "postgresql"
}

// Guilds table (per-server game configuration)
model Guild {
  guildId         String   @id @map("guild_id") @db.VarChar(20)
  numMafia        Int      @default(1) @map("num_mafia") @db.Integer
  inProgress      Boolean  @default(false) @map("in_progress")
  gameState       String   @default("IDLE") @map("game_state") @db.VarChar(20)
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  players     Player[]
  activeRound ActiveRound?
  gameHistory GameHistory[]

  @@map("guilds")
}

// Players table (per-server player stats and ELO ratings)
model Player {
  id          Int     @id @default(autoincrement())
  guildId     String  @map("guild_id") @db.VarChar(20)
  userId      String  @map("user_id") @db.VarChar(20)
  displayName String? @map("display_name") @db.VarChar(100)

  // ELO rating system
  elo          Int @default(1000)
  totalRounds  Int @default(0) @map("total_rounds")
  mafiaRounds  Int @default(0) @map("mafia_rounds")
  mafiaWins    Int @default(0) @map("mafia_wins")
  correctVotes Int @default(0) @map("correct_votes")
  totalVotes   Int @default(0) @map("total_votes")
  peakElo      Int @default(1000) @map("peak_elo")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  guild Guild @relation(fields: [guildId], references: [guildId], onDelete: Cascade)

  @@unique([guildId, userId])
  @@index([guildId, userId])
  @@index([guildId, elo(sort: Desc)])
  @@map("players")
}

// Active rounds table (current game state per guild)
model ActiveRound {
  id          Int      @id @default(autoincrement())
  guildId     String   @unique @map("guild_id") @db.VarChar(20)
  mafiaIds    String[] @map("mafia_ids")
  innocentIds String[] @map("innocent_ids")
  playerTeams Json     @map("player_teams") // Map of user_id -> team number (1 or 2)
  votes       Json     @default("{}") // Map of voter_id -> suspect_id
  winningTeam Int?     @map("winning_team") // 1 or 2, NULL until reported
  startedAt   DateTime @default(now()) @map("started_at")

  // Relations
  guild Guild @relation(fields: [guildId], references: [guildId], onDelete: Cascade)

  @@map("active_rounds")
}

// Game history table (completed rounds for analytics)
model GameHistory {
  id          Int      @id @default(autoincrement())
  guildId     String   @map("guild_id") @db.VarChar(20)
  mafiaIds    String[] @map("mafia_ids")
  winningTeam Int      @map("winning_team") // Which RL team won (1 or 2)
  mafiaWon    Boolean  @map("mafia_won") // Did mafia successfully sabotage?
  votes       Json // Vote records
  eloChanges  Json     @map("elo_changes") // Map of user_id -> ELO delta
  playedAt    DateTime @default(now()) @map("played_at")

  // Relations
  guild Guild @relation(fields: [guildId], references: [guildId], onDelete: Cascade)

  @@index([guildId, playedAt(sort: Desc)])
  @@map("game_history")
}

// Schema migrations tracking
model SchemaMigration {
  version   Int      @id
  appliedAt DateTime @default(now()) @map("applied_at")

  @@map("schema_migrations")
}
